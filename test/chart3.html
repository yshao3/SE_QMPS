<!-- Styles -->
<style>
#chartdiv {
  width: 100%;
  height: 500px;
}
</style>

<!-- Resources -->
<script src="https://www.amcharts.com/lib/3/amcharts.js"></script>
<script src="https://www.amcharts.com/lib/3/serial.js"></script>
<script src="https://www.amcharts.com/lib/3/plugins/export/export.min.js"></script>
<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />
<script src="https://www.amcharts.com/lib/3/themes/light.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<!-- Chart code -->
<script>
var unit_data = [
  {
      Date: '2017-11-31',
      Observer: 'Jone',
      Farm: 'Glezon',
      Good: 132,
      Bad: 21
  },
  {
      Date: '2017-12-04',
      Observer: 'Alex',
      Farm: 'Glezon',
      Good: 99,
      Bad: 31
  },
  {
      Date: '2017-12-16',
      Observer: 'Gina',
      Farm: 'Glezon',
      Good: 70,
      Bad: 35
  },
    {
        Date: '2017-12-22',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-01-15',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-02-02',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-05',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-02-06',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-07',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-02-08',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-09',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-02-10',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-13',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-02-15',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-16',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-02-19',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-02-25',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-03-01',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-03-05',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-03-06',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-03-15',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-03-16',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-03-17',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-04-10',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-04-21',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-04-22',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-04-23',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-04-24',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-04-25',
        Observer: 'Irine',
        Farm: 'Glezon',
        Good: 65,
        Bad: 10
    },
    {
        Date: '2018-04-26',
        Observer: 'Jone',
        Farm: 'Glezon',
        Good: 132,
        Bad: 21
    },
    {
        Date: '2018-04-30',
        Observer: 'Alex',
        Farm: 'Glezon',
        Good: 99,
        Bad: 31
    },
    {
        Date: '2018-04-30',
        Observer: 'Gina',
        Farm: 'Glezon',
        Good: 70,
        Bad: 35
    },
    {
        Date: '2018-05-03',
        Observer: 'Zeiger',
        Farm: 'Glezon',
        Good: 90,
        Bad: 36
    }];
var formatComma = d3.format(",");
var datanest = d3.nest().key(function(d) { return d.Date; })
                        .rollup(function(v) { return {
                            total: d3.sum(v, function(d) { return d.Good + d.Bad; }),
                            good: formatComma(d3.sum(v, function(d) { return d.Good; })/d3.sum(v, function(d) { return d.Good + d.Bad; }) * 100),
                            bad: d3.sum(v, function(d) { return d.Bad; })/d3.sum(v, function(d) { return d.Good + d.Bad; })
                          }; })
                        .entries(unit_data);
console.log(datanest);


var unitset = [];
for(var i = 0; i < datanest.length; i ++){
  console.log(i);
   var token = {};
   token.date = datanest[i].key;
   token.sales1 = Math.round(datanest[i].value.good);
   token.sales2 = Math.round(datanest[i].value.bad.toFixed(2)*100);
   unitset.push(token);
   console.log(token);
 }


var chart = AmCharts.makeChart("chartdiv", {
  "type": "serial",
  "theme": "light",
  "dataDateFormat": "YYYY-MM-DD",
  "precision": 2,
  "valueAxes": [{
    "id": "v1",
    "title": "Unit Alignment",
    "position": "left",
    "autoGridCount": false,
    "labelFunction": function(value) {
      return value + "%";
    }
  }],
  "graphs": [{
    "id": "g3",
    "valueAxis": "v1",
    //bad unit data display
    "lineColor": "#FA4659",
    "fillColors": "#FA4659",
    // "lineColor": "#e1ede9",
    // "fillColors": "#e1ede9",
    "fillAlphas": 1,
    "type": "column",
    "title": "Improper Unit Alignment",
    "valueField": "sales2",
    "clustered": false,
    "columnWidth": 0.5,
    "legendValueText": "[[value]]%",
    //浮标label
    "balloonText": "[[title]]<br /><b style='font-size: 130%'>[[value]]%</b>"
  }, {
    "id": "g4",
    "valueAxis": "v1",
    // "lineColor": "#62cf73",
    "lineColor": "#7CDFFF",
    "fillColors": "#7CDFFF",
    // "fillColors": "#62cf73",
    "fillAlphas": 1,
    "type": "column",
    "title": "Proper Unit Alignment",
    "valueField": "sales1",
    "clustered": false,
    "columnWidth": 0.3,
    "legendValueText": "[[value]]%",
    "balloonText": "[[title]]<br /><b style='font-size: 130%'>[[value]]%</b>"
  }],
  "chartScrollbar": {
    "graph": "g1",
    "oppositeAxis": false,
    "offset": 30,
    "scrollbarHeight": 50,
    "backgroundAlpha": 0,
    "selectedBackgroundAlpha": 0.1,
    "selectedBackgroundColor": "#888888",
    "graphFillAlpha": 0,
    "graphLineAlpha": 0.5,
    "selectedGraphFillAlpha": 0,
    "selectedGraphLineAlpha": 1,
    "autoGridCount": true,
    "color": "#AAAAAA"
  },
  "chartCursor": {
    "pan": true,
    //是否显示游标线对齐
    "valueLineEnabled": false,
    //左侧坐标轴balloon显示
    "valueLineBalloonEnabled": false,
    "cursorAlpha": 0,
    "valueLineAlpha": 0.2
  },
  "categoryField": "date",
  "categoryAxis": {
    "parseDates": true,
    "dashLength": 1,
    "minorGridEnabled": true
  },
  "legend": {
    "useGraphSettings": true,
    "position": "top"
  },
  "balloon": {
    "borderThickness": 1,
    "shadowAlpha": 0
  },
  "export": {
   "enabled": true
  },
   "dataProvider": unitset
});
</script>

<!-- HTML -->
<div id="chartdiv"></div>
